name: Environment Cleanup

on:
  schedule:
    - cron: '0 */3 * * *'  # Runs every 3 hours
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Cleanup expired preview environments
        run: |
          kubectl get namespaces -l environment=preview -o json | \
          jq -r '.items[] | select((.metadata.creationTimestamp | fromdateiso8601) < (now - 10800)) | .metadata.name' | \
          while read namespace; do
            echo "Cleaning up namespace: $namespace"
            kubectl delete namespace $namespace --timeout=60s
          done
