name: 'Trivy Security Scan'
description: 'Centralized Trivy security scanning for filesystem and container images'
inputs:
  scan-type:
    description: 'Type of scan (fs or image)'
    required: true
    default: 'fs'
  scan-ref:
    description: 'What to scan (directory path or image name)'
    required: false
    default: '.'
  severity:
    description: 'Severity levels to check'
    required: false
    default: 'CRITICAL,HIGH'
  scanners:
    description: 'Scanners to use'
    required: false
    default: 'vuln,secret,config'
  ignore-unfixed:
    description: 'Ignore unfixed vulnerabilities'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Install Trivy
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
        
    - name: Run Trivy scan
      shell: bash
      run: |
        SCAN_TYPE="${{ inputs.scan-type }}"
        SCAN_REF="${{ inputs.scan-ref }}"
        SEVERITY="${{ inputs.severity }}"
        SCANNERS="${{ inputs.scanners }}"
        IGNORE_UNFIXED="${{ inputs.ignore-unfixed }}"
        
        echo "Running Trivy $SCAN_TYPE scan on: $SCAN_REF"
        echo "Severity: $SEVERITY"
        echo "Scanners: $SCANNERS"
        
        if [ "$SCAN_TYPE" = "fs" ]; then
          trivy filesystem "$SCAN_REF" \
            --format table \
            --severity "$SEVERITY" \
            --scanners "$SCANNERS" \
            --exit-code 1 \
            --no-progress \
            $( [ "$IGNORE_UNFIXED" = "true" ] && echo "--ignore-unfixed" )
        elif [ "$SCAN_TYPE" = "image" ]; then
          trivy image "$SCAN_REF" \
            --format table \
            --severity "$SEVERITY" \
            --scanners "$SCANNERS" \
            --exit-code 1 \
            --no-progress \
            $( [ "$IGNORE_UNFIXED" = "true" ] && echo "--ignore-unfixed" )
        else
          echo "Error: Invalid scan type. Use 'fs' or 'image'"
          exit 1
        fi
