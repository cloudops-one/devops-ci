name: React Build
description: Builds a React (Vite) application with environment-based configuration.

inputs:
  node-version:
    description: 'The Node.js version to use'
    required: true
  skip-husky:
    description: 'Skip the Husky git hooks'
    required: false
    default: 'false'
  generate-lockfile:
    description: 'Generate a lockfile for npm'
    required: false
    default: 'true'
  environment:
    description: 'Deployment environment (live, stage, preview)'
    required: true

runs:
  using: "composite"
  steps:
    # -------------------------------
    # 1Ô∏è‚É£ Setup Node
    # -------------------------------
    - name: Use Node.js ${{ inputs.node-version }}
      uses: cloudops-one/setup-node@v1
      with:
        node-version: ${{ inputs.node-version }}

    # -------------------------------
    # 2Ô∏è‚É£ Install dependencies
    # -------------------------------
    - name: Install dependencies
      run: npm install
      shell: bash

    # -------------------------------
    # 3Ô∏è‚É£ Dynamically configure .env
    # -------------------------------
    - name: Configure environment for Vite build
      shell: bash
      run: |
        ENVIRONMENT="${{ inputs.environment }}"
        echo "üåç Setting VITE_API_BASE_URL for environment: $ENVIRONMENT"

        case "$ENVIRONMENT" in
          live)
            BASE_URL="https://server.live.v1.irai.yoga/api/"
            ;;
          stage)
            BASE_URL="https://server.stage.v1.irai.yoga/api/"
            ;;
          *)
            BASE_URL="https://server.preview.v1.irai.yoga/api/"
            ;;
        esac

        echo "VITE_API_BASE_URL=$BASE_URL" > .env
        echo "‚úÖ .env file content:"
        cat .env

    # -------------------------------
    # 4Ô∏è‚É£ Lint and autofix
    # -------------------------------
    - name: Run lint and autofix
      run: npm run lint --fix
      shell: bash

    # -------------------------------
    # 5Ô∏è‚É£ Build React app
    # -------------------------------
    - name: Run build
      run: npm run build
      shell: bash

    # -------------------------------
    # 6Ô∏è‚É£ Upload build artifacts
    # -------------------------------
    - name: Upload production-ready build files
      uses: cloudops-one/upload-artifact@main
      with:
        name: build-artifact
        path: dist

    # -------------------------------
    # 7Ô∏è‚É£ Optional helpers
    # -------------------------------
    - name: Skip Husky
      if: ${{ inputs.skip-husky == 'true' }}
      run: |
        if [ -f .husky/pre-commit ]; then
          mv .husky/pre-commit .husky/pre-commit.bak
        fi
      shell: bash

    - name: Generate lockfile
      if: ${{ inputs.generate-lockfile == 'true' }}
      run: npm install --package-lock-only
      shell: bash
