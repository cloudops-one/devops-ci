name: 'SonarQube Scan'
description: 'Centralized SonarQube code quality scanning for Backend'

inputs:
  sonar-token:
    description: 'SonarQube token'
    required: true
  sonar-host-url:
    description: 'SonarQube host URL'
    required: true
  project-key:
    description: 'SonarQube project key'
    required: true
  project-name:
    description: 'SonarQube project name'
    required: true
  docker-tag:
    description: 'Docker tag for project version'
    required: true
  branch-name:
    description: 'Git branch name'
    required: true
  sources-path:
    description: 'Path to source code'
    default: 'src'
    required: false

runs:
  using: 'composite'
  steps:
    # 1️⃣ Checkout full repository to enable blame info
    - name: Checkout code
      uses: cloudops-one/checkout@v4
      with:
        fetch-depth: 0

    # 2️⃣ Setup JDK for Sonar
    - name: Set up JDK for SonarScanner
      uses: cloudops-one/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3️⃣ Make gradlew executable
    - name: Make gradlew executable
      shell: bash
      run: |
        chmod +x ./gradlew
        ls -la gradlew

    # 4️⃣ Apply Spotless formatting
    - name: Apply Spotless formatting
      shell: bash
      run: ./gradlew spotlessApply

    # 5️⃣ Build project with tests and generate Jacoco XML report
    - name: Build project with tests and coverage
      shell: bash
      run: |
        ./gradlew clean build jacocoTestReport

    # 6️⃣ Run SonarQube Analysis with proper quoting
    - name: Run SonarQube Analysis
      shell: bash
      env:
        SONAR_TOKEN: ${{ inputs.sonar-token }}
        SONAR_HOST_URL: ${{ inputs.sonar-host-url }}
      run: |
        echo "Running SonarQube analysis..."
        ./gradlew sonar \
          -Dsonar.token="$SONAR_TOKEN" \
          -Dsonar.host.url="$SONAR_HOST_URL" \
          -Dsonar.projectKey="${{ inputs.project-key }}" \
          -Dsonar.projectName="${{ inputs.project-name }}" \
          -Dsonar.projectVersion="${{ inputs.docker-tag }}" \
          -Dsonar.sources="${{ inputs.sources-path }}" \
          -Dsonar.tests="${{ inputs.sources-path }}" \
          -Dsonar.test.inclusions="**/*Test.java,**/*Tests.java,**/*Spec.java" \
          -Dsonar.java.binaries="build/classes" \
          -Dsonar.coverage.jacoco.xmlReportPaths="build/reports/jacoco/test/jacocoTestReport.xml" \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.sourceEncoding="UTF-8" \
          -Dsonar.gradle.skipCompile=true

    # 7️⃣ Print a summary
    - name: SonarQube Analysis Summary
      shell: bash
      run: |
        echo "=== SonarQube Backend Scan Summary ==="
        echo "Project: ${{ inputs.project-name }}"
        echo "Key: ${{ inputs.project-key }}"
        echo "Version: ${{ inputs.docker-tag }}"
        echo "Branch: ${{ inputs.branch-name }}"
        echo "Source Path: ${{ inputs.sources-path }}"
        echo "Edition: Community (branch analysis disabled)"
        echo "=============================="
